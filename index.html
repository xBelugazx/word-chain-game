<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ëë§ì‡ê¸° (AI íŒíŠ¸ âœ¨)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter & Noto Sans KR -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-2xl mx-auto bg-white flex flex-col h-screen md:h-auto md:max-h-[95vh] md:my-4 md:rounded-2xl md:shadow-xl">
        
        <div id="loading-screen" class="flex-1 flex items-center justify-center p-8">
            <p class="text-xl text-gray-600">ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- ë¡œë¹„ í™”ë©´ -->
        <div id="lobby-screen" class="hidden p-6 md:p-8 flex flex-col h-full">
            <div class="flex-shrink-0 mb-4">
                <h1 class="text-3xl font-bold text-center text-gray-800">ê²Œì„ ë¡œë¹„ ğŸ®</h1>
                <p class="text-center text-gray-500">ì°¸ì—¬í•  ë°©ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆ ë°©ì„ ë§Œë“œì„¸ìš”.</p>
            </div>
            <div class="flex-grow bg-gray-50 rounded-lg p-4 overflow-y-auto custom-scrollbar border">
                <div id="public-rooms-list" class="space-y-2">
                    <!-- ê³µê°œ ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                </div>
            </div>
            <div class="flex-shrink-0 mt-4">
                <button id="open-create-room-modal-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition text-lg">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
            </div>
        </div>

        <!-- ê²Œì„ í™”ë©´ -->
        <div id="game-screen" class="hidden flex-1 flex flex-col p-4 space-y-4 min-h-0">
            <!-- ìƒë‹¨ ì •ë³´ -->
            <div class="flex-shrink-0 space-y-4">
                <div class="flex justify-between items-center">
                    <button id="leave-room-btn" class="text-sm text-gray-500 hover:text-gray-800">â† ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
                    <p id="room-name-display" class="text-2xl font-semibold text-indigo-600"></p>
                    <!-- ë°© í­íŒŒ ë²„íŠ¼ (ë°©ì¥ì—ê²Œë§Œ ë³´ì„) -->
                    <button id="delete-room-btn" class="hidden text-sm bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200">ë°© í­íŒŒ</button>
                </div>
                <div id="game-info" class="p-4 bg-gray-50 rounded-lg text-center">
                    <p class="text-lg">ì œì‹œì–´: <span id="last-word" class="text-4xl font-bold text-blue-600"></span></p>
                    <p id="turn-info" class="text-xl font-medium text-gray-700 h-8"></p>
                </div>
            </div>
            
            <!-- ë‹¨ì–´ ê¸°ë¡ (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
            <div id="word-history" class="flex-grow p-4 bg-gray-100 rounded-lg border border-gray-200 overflow-y-auto custom-scrollbar min-h-0">
                <ul id="word-list" class="space-y-3"></ul>
            </div>
            
            <!-- í•˜ë‹¨ ì…ë ¥ë¶€ -->
            <div class="flex-shrink-0 space-y-3">
                <div id="hint-display" class="text-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                    <p class="text-base text-gray-600">âœ¨ AI ì¶”ì²œ ë‹¨ì–´: <span id="hint-word" class="font-bold text-yellow-800"></span></p>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="text" id="word-input" placeholder="ë‹¨ì–´ë¥¼ ì…ë ¥..." class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg" disabled>
                    <button id="hint-btn" class="bg-yellow-400 text-white font-bold p-3 rounded-lg hover:bg-yellow-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                        <span id="hint-btn-text" class="text-2xl">âœ¨</span>
                    </button>
                    <button id="send-btn" class="bg-blue-500 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed text-lg">ì „ì†¡</button>
                </div>
                 <button id="reset-game-btn" class="w-full bg-yellow-500 text-yellow-800 font-bold py-3 rounded-lg hover:bg-yellow-600 transition text-base">ê²Œì„ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <!-- ë°© ë§Œë“¤ê¸° ëª¨ë‹¬ -->
    <div id="create-room-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md space-y-4">
            <h2 class="text-2xl font-bold">ìƒˆ ë°© ë§Œë“¤ê¸°</h2>
            <input type="text" id="nickname-input" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            <input type="text" id="room-name-input" placeholder="ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì—†ìœ¼ë©´ ê³µê°œ ë°©)" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            <div class="flex justify-end space-x-4">
                <button id="cancel-create-btn" class="px-4 py-2 rounded text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                <button id="confirm-create-btn" class="px-4 py-2 rounded bg-green-500 text-white hover:bg-green-600">ë§Œë“¤ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md space-y-4">
            <h2 class="text-2xl font-bold">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h2>
            <p>ì´ ë°©ì— ì°¸ì—¬í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="text" id="join-nickname-input" placeholder="ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            <input type="password" id="join-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border rounded-lg" autocomplete="off">
            <div class="flex justify-end space-x-4">
                <button id="cancel-join-btn" class="px-4 py-2 rounded text-gray-600 hover:bg-gray-100">ì·¨ì†Œ</button>
                <button id="confirm-join-btn" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">ì°¸ì—¬í•˜ê¸°</button>
            </div>
        </div>
    </div>


    <!-- Firebase & Gemini Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ìš”ì†Œ ---
        const loadingScreen = document.getElementById('loading-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const publicRoomsList = document.getElementById('public-rooms-list');
        const openCreateRoomModalBtn = document.getElementById('open-create-room-modal-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const deleteRoomBtn = document.getElementById('delete-room-btn');
        // ëª¨ë‹¬ ìš”ì†Œ
        const createRoomModal = document.getElementById('create-room-modal');
        const passwordModal = document.getElementById('password-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const roomNameInput = document.getElementById('room-name-input');
        const passwordInput = document.getElementById('password-input');
        const cancelCreateBtn = document.getElementById('cancel-create-btn');
        const confirmCreateBtn = document.getElementById('confirm-create-btn');
        const joinNicknameInput = document.getElementById('join-nickname-input');
        const joinPasswordInput = document.getElementById('join-password-input');
        const cancelJoinBtn = document.getElementById('cancel-join-btn');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        // ê²Œì„ í™”ë©´ ìš”ì†Œ
        const roomNameDisplay = document.getElementById('room-name-display');
        const lastWordEl = document.getElementById('last-word');
        const turnInfoEl = document.getElementById('turn-info');
        const wordListEl = document.getElementById('word-list');
        const wordInput = document.getElementById('word-input');
        const sendBtn = document.getElementById('send-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const hintBtn = document.getElementById('hint-btn');

        // --- Firebase ì„¤ì • ---
        const firebaseConfig = {
          apiKey: "AIzaSyC4NyJ4kTK4VTrFBaIWsBUWtcaSK21KBBg",
          authDomain: "my-word-game-510f9.firebaseapp.com",
          projectId: "my-word-game-510f9",
          storageBucket: "my-word-game-510f9.firebasestorage.app",
          messagingSenderId: "766315896698",
          appId: "1:766315896698:web:cd32a3ac30e85292a8c0c3"
        };
        const appId = firebaseConfig.projectId;
        let app, db, auth, userId, currentGameId;
        let unsubscribeGame = null;
        let unsubscribeRooms = null;

        // --- ë©”ì¸ ë¡œì§ ---
        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        showLobby();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                loadingScreen.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        function showLobby() {
            loadingScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            listenToPublicRooms();
        }

        function showGame(roomId) {
            lobbyScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            roomNameDisplay.textContent = roomId;
        }

        // --- ê³µê°œ ë°© ëª©ë¡ ì‹¤ì‹œê°„ ê°ì§€ (ë¡œì§ ìˆ˜ì •) ---
        function listenToPublicRooms() {
            if (unsubscribeRooms) unsubscribeRooms();
            const roomsRef = collection(db, `artifacts/${appId}/public/data/games`);
            const q = query(roomsRef, where("status", "==", "waiting"));

            unsubscribeRooms = onSnapshot(q, (querySnapshot) => {
                publicRoomsList.innerHTML = '';
                if (querySnapshot.empty) {
                    publicRoomsList.innerHTML = `<p class="text-gray-500 text-center">ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>`;
                }
                querySnapshot.forEach((doc) => {
                    const room = doc.data();
                    const roomEl = document.createElement('div');
                    roomEl.className = 'p-4 bg-white rounded-lg shadow flex justify-between items-center cursor-pointer hover:bg-gray-50';
                    roomEl.dataset.roomId = doc.id;
                    roomEl.dataset.passwordProtected = !!room.password;
                    
                    roomEl.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${doc.id}</p>
                            <p class="text-sm text-gray-600">${Object.keys(room.players).length} / 2 ëª…</p>
                        </div>
                        ${room.password ? '<span>ğŸ”’</span>' : ''}
                    `;
                    publicRoomsList.appendChild(roomEl);
                });
            });
        }

        // --- ë°© ë§Œë“¤ê¸° ë° ì°¸ì—¬ ë¡œì§ ---
        async function createRoom(nickname, roomName, password) {
            if (!nickname || !roomName) {
                alert("ë‹‰ë„¤ì„ê³¼ ë°© ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games`, roomName);
            const docSnap = await getDoc(gameDocRef);

            if (docSnap.exists()) {
                alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°© ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                return;
            }

            await setDoc(gameDocRef, {
                creatorUid: userId,
                players: { [userId]: { nickname } },
                words: [],
                lastWord: "",
                currentPlayerUid: userId,
                status: 'waiting',
                isPublic: !password,
                password: password || null,
                createdAt: new Date()
            });

            startListeningToGame(gameDocRef, roomName);
        }

        async function joinRoom(roomId, nickname, passwordAttempt = null) {
            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games`, roomId);
            const docSnap = await getDoc(gameDocRef);

            if (!docSnap.exists()) {
                alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
                return;
            }

            const gameData = docSnap.data();
            if (gameData.password && gameData.password !== passwordAttempt) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                return;
            }
            
            if (Object.keys(gameData.players).length >= 2 && !gameData.players[userId]) {
                alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const updateData = {
                [`players.${userId}`]: { nickname },
                status: 'playing'
            };
            await updateDoc(gameDocRef, updateData);

            passwordModal.classList.add('hidden');
            startListeningToGame(gameDocRef, roomId);
        }

        function startListeningToGame(gameDocRef, roomId) {
            if (unsubscribeRooms) unsubscribeRooms();
            if (unsubscribeGame) unsubscribeGame();
            
            currentGameId = roomId;

            unsubscribeGame = onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    updateUI(docSnap.data());
                } else {
                    alert("ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
                    leaveRoom(true); // ë°©ì´ ì™¸ë¶€ì—ì„œ ì‚­ì œëœ ê²½ìš°
                }
            });
            showGame(roomId);
        }
        
        async function leaveRoom(isKicked = false) {
            const roomId = currentGameId;
            if (unsubscribeGame) unsubscribeGame();
            unsubscribeGame = null;
            currentGameId = null;
            
            if (roomId && !isKicked) {
                try {
                    const gameDocRef = doc(db, `artifacts/${appId}/public/data/games`, roomId);
                    const docSnap = await getDoc(gameDocRef);

                    if (docSnap.exists()) {
                        const gameData = docSnap.data();
                        const players = gameData.players;

                        delete players[userId];

                        if (Object.keys(players).length === 0 || gameData.creatorUid === userId) {
                            await deleteDoc(gameDocRef);
                        } else {
                            await updateDoc(gameDocRef, {
                                players: players,
                                status: 'waiting',
                                words: [],
                                lastWord: "",
                                currentPlayerUid: Object.keys(players)[0] // ë‚¨ì€ í”Œë ˆì´ì–´ì—ê²Œ í„´ ë„˜ê¹€
                            });
                        }
                    }
                } catch (error) {
                    console.error("Error leaving room:", error);
                }
            }
            
            showLobby();
        }

        // --- UI ì—…ë°ì´íŠ¸ ---
        function updateUI(gameData) {
            if (!gameData) return;
            const { players, currentPlayerUid, words, lastWord, status, creatorUid } = gameData;
            const isMyTurn = currentPlayerUid === userId;
            const isGameFull = Object.keys(players).length === 2;
            
            // ë°©ì¥ì¸ ê²½ìš° ë°© í­íŒŒ ë²„íŠ¼ í‘œì‹œ
            if (creatorUid === userId) {
                deleteRoomBtn.classList.remove('hidden');
            } else {
                deleteRoomBtn.classList.add('hidden');
            }

            wordListEl.innerHTML = '';
            words.forEach(item => {
                const li = document.createElement('li');
                const nickname = players[item.player]?.nickname || 'ì•Œìˆ˜ì—†ìŒ';
                const isMyMessage = item.player === userId;
                li.className = `p-3 rounded-lg ${isMyMessage ? 'bg-blue-50 text-right' : 'bg-green-50 text-left'}`;
                li.innerHTML = `<span class="font-bold ${isMyMessage ? 'text-blue-600' : 'text-green-600'}">${nickname}</span>: <span class="text-xl text-gray-800">${item.word}</span>`;
                wordListEl.appendChild(li);
            });
            if (wordListEl.scrollHeight > wordListEl.clientHeight) {
                wordListEl.scrollTop = wordListEl.scrollHeight;
            }
            
            const currentPlayerNickname = players[currentPlayerUid]?.nickname;

            if (status === 'waiting' && !isGameFull) {
                turnInfoEl.textContent = "ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
                lastWordEl.textContent = "ëŒ€ê¸°ì¤‘";
                wordInput.disabled = true;
                sendBtn.disabled = true;
                hintBtn.disabled = true;
            } else if (words.length === 0) {
                lastWordEl.textContent = "ê²Œì„ ì‹œì‘!";
                turnInfoEl.textContent = isMyTurn ? `${players[userId].nickname}ë‹˜, ì²« ë‹¨ì–´ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”!` : `${currentPlayerNickname}ë‹˜ì´ ì²« ë‹¨ì–´ë¥¼ ì œì‹œí•©ë‹ˆë‹¤...`;
                wordInput.disabled = !isMyTurn;
                sendBtn.disabled = !isMyTurn;
                hintBtn.disabled = true;
            } else {
                lastWordEl.textContent = lastWord;
                turnInfoEl.textContent = isMyTurn ? `${players[userId].nickname}ë‹˜ ì°¨ë¡€ì…ë‹ˆë‹¤!` : `${currentPlayerNickname}ë‹˜ ì°¨ë¡€ì…ë‹ˆë‹¤...`;
                wordInput.disabled = !isMyTurn;
                sendBtn.disabled = !isMyTurn;
                hintBtn.disabled = !isMyTurn;
            }
            if(isMyTurn) wordInput.focus();
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        openCreateRoomModalBtn.addEventListener('click', () => createRoomModal.classList.remove('hidden'));
        cancelCreateBtn.addEventListener('click', () => createRoomModal.classList.add('hidden'));
        confirmCreateBtn.addEventListener('click', () => {
            createRoom(nicknameInput.value.trim(), roomNameInput.value.trim(), passwordInput.value.trim());
            createRoomModal.classList.add('hidden');
        });
        
        publicRoomsList.addEventListener('click', (e) => {
            const roomEl = e.target.closest('[data-room-id]');
            if (!roomEl) return;
            
            const { roomId, passwordProtected } = roomEl.dataset;
            passwordModal.dataset.roomId = roomId;
            
            if (passwordProtected === 'true') {
                joinNicknameInput.value = '';
                joinPasswordInput.value = '';
                passwordModal.classList.remove('hidden');
            } else {
                const nickname = prompt("ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:");
                if(nickname) joinRoom(roomId, nickname);
            }
        });
        
        cancelJoinBtn.addEventListener('click', () => passwordModal.classList.add('hidden'));
        confirmJoinBtn.addEventListener('click', () => {
            const roomId = passwordModal.dataset.roomId;
            const nickname = joinNicknameInput.value.trim();
            const password = joinPasswordInput.value.trim();
            if(nickname) joinRoom(roomId, nickname, password);
        });

        leaveRoomBtn.addEventListener('click', () => leaveRoom(false));
        
        deleteRoomBtn.addEventListener('click', async () => {
            if (confirm("ì •ë§ë¡œ ì´ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  í”Œë ˆì´ì–´ê°€ ë¡œë¹„ë¡œ ì´ë™ë©ë‹ˆë‹¤.")) {
                const gameDocRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
                await deleteDoc(gameDocRef);
            }
        });
        
        sendBtn.addEventListener('click', handleSendWord);
        wordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendWord(); });
        
        async function handleSendWord() {
            const word = wordInput.value.trim();
            if (!word || word.length < 2) return alert("ë‘ ê¸€ì ì´ìƒì˜ ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const gameDocRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
            const gameDoc = await getDoc(gameDocRef);

            if (gameDoc.exists()) {
                const gameData = gameDoc.data();
                if (gameData.words.length > 0 && gameData.lastWord.charAt(gameData.lastWord.length - 1) !== word.charAt(0)) {
                    return alert("ì´ì „ ë‹¨ì–´ì˜ ë§ˆì§€ë§‰ ê¸€ìë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.");
                }
                if (gameData.words.some(item => item.word === word)) {
                    return alert("ì´ë¯¸ ì‚¬ìš©ëœ ë‹¨ì–´ì…ë‹ˆë‹¤.");
                }

                const playerIds = Object.keys(gameData.players);
                const nextPlayerUid = playerIds.find(p => p !== userId) || userId;
                
                await updateDoc(gameDocRef, {
                    words: [...gameData.words, { player: userId, word: word }],
                    lastWord: word,
                    currentPlayerUid: nextPlayerUid
                });
                wordInput.value = '';
            }
        }
        
        resetGameBtn.addEventListener('click', async () => {
            if (confirm("ì •ë§ë¡œ ê²Œì„ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë‹¨ì–´ ê¸°ë¡ë§Œ ì‚­ì œë©ë‹ˆë‹¤.")) {
                 const gameDocRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
                 const gameDoc = await getDoc(gameDocRef);
                 if(gameDoc.exists()){
                    await updateDoc(gameDocRef, {
                        words: [], lastWord: "", currentPlayerUid: gameDoc.data().creatorUid
                    });
                 }
            }
        });

        main();
    </script>
</body>
</html>
